# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Prompt Caching

## üéØ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à `config.yaml` –∏ –∏–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—É—é:

**–ë—ã–ª–æ:**
```yaml
llm:
  providers:
    1:
      model_env: OPENAI_MODEL_1
      # –í .env: OPENAI_MODEL_1=gpt-4-turbo
```

**–°—Ç–∞–ª–æ:**
```yaml
llm:
  providers:
    1:
      model_env: OPENAI_MODEL_1
      # –í .env: OPENAI_MODEL_1=gpt-4o
      # –∏–ª–∏: OPENAI_MODEL_1=gpt-4o-mini (–¥–µ—à–µ–≤–ª–µ)
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í –≤–∞—à–µ–º `.env` —Ñ–∞–π–ª–µ:

```bash
# –ò–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é prompt caching
OPENAI_MODEL_1=gpt-4o           # –∏–ª–∏ gpt-4o-mini
OPENAI_API_KEY_1=sk-proj-...    # –í–∞—à API –∫–ª—é—á OpenAI

# Fallback –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
OPENAI_MODEL_2=gpt-4o-mini
OPENAI_API_KEY_2=sk-proj-...
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

```bash
status-validator --config config.yaml --verbose --limit 10
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–í –ª–æ–≥–∞—Ö –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
[INFO] Validating rows 13-22
[DEBUG] Validating row 13
[DEBUG] No cached tokens in this request (total: 2687 tokens)
[DEBUG] Validating row 14
[INFO] Prompt cache hit: 2487/2698 tokens (92.2%) | Total: 3421 tokens
[DEBUG] Validating row 15
[INFO] Prompt cache hit: 2487/2712 tokens (91.7%) | Total: 3435 tokens
```

‚úÖ **–£—Å–ø–µ—Ö!** –ù–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, ~90% –ø—Ä–æ–º–ø—Ç–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π 50%!

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –í `prompt_builder.py`

–ü—Ä–æ–º–ø—Ç—ã —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞:
[
    {"role": "system", "content": "..."},      # –°—Ç–∞—Ç–∏–∫–∞
    {"role": "user", "content": "Rules..."},   # –°—Ç–∞—Ç–∏–∫–∞ (–∫–µ—à–∏—Ä—É–µ—Ç—Å—è)
    {"role": "assistant", "content": "..."},   # –°—Ç–∞—Ç–∏–∫–∞
    {"role": "user", "content": "Row data..."} # –î–∏–Ω–∞–º–∏–∫–∞
]
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- OpenAI –∫–µ—à–∏—Ä—É–µ—Ç —Å–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –ø—Ä–æ–º–ø—Ç–∞
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏ (rules_text, allowed_statuses) –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è

### –í `llm_client.py`

–î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–µ—à–∞:

```python
# –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏:
if cached_tokens > 0:
    LOGGER.info(
        "Prompt cache hit: %d/%d tokens (%.1f%%) | Total: %d tokens",
        cached_tokens, prompt_tokens, cache_hit_rate, total_tokens
    )
```

## üí∞ –û–∂–∏–¥–∞–µ–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–º–ø—Ç—ã:**
- System prompt: ~500 —Ç–æ–∫–µ–Ω–æ–≤
- Rules + allowed statuses: ~2000 —Ç–æ–∫–µ–Ω–æ–≤
- Row data: ~100-300 —Ç–æ–∫–µ–Ω–æ–≤
- **–ò—Ç–æ–≥–æ:** ~2600-2800 —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å

**–° prompt caching (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞):**
- Cached (~2500 —Ç–æ–∫–µ–Ω–æ–≤): **—Å–∫–∏–¥–∫–∞ 50%**
- Uncached row data (~200 —Ç–æ–∫–µ–Ω–æ–≤): **–ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞**

### –†–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (GPT-4o)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë–µ–∑ –∫–µ—à–∞ | –° –∫–µ—à–µ–º | –≠–∫–æ–Ω–æ–º–∏—è |
|---------|----------|---------|----------|
| Input —Ç–æ–∫–µ–Ω—ã (100 —Å—Ç—Ä–æ–∫) | 270,000 | 137,500 | **49%** |
| –°—Ç–æ–∏–º–æ—Å—Ç—å input @ $2.50/1M | $0.675 | $0.344 | **$0.331** |
| –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (—Å—Ä–µ–¥–Ω–µ–µ) | 2.5 —Å–µ–∫ | 1.8 —Å–µ–∫ | **28%** |

### –ì–æ–¥–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è (–ø—Ä–∏–º–µ—Ä)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –í–∞–ª–∏–¥–∞—Ü–∏—è 200 —Å—Ç—Ä–æ–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

```
–ë–µ–∑ –∫–µ—à–∞:
200 —Å—Ç—Ä–æ–∫ √ó 2,700 —Ç–æ–∫–µ–Ω–æ–≤ √ó 250 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π = 135,000,000 —Ç–æ–∫–µ–Ω–æ–≤/–≥–æ–¥
–°—Ç–æ–∏–º–æ—Å—Ç—å: $337.50/–≥–æ–¥

–° –∫–µ—à–µ–º:
135,000,000 √ó 0.51 = ~68,850,000 —Ç–æ–∫–µ–Ω–æ–≤/–≥–æ–¥
–°—Ç–æ–∏–º–æ—Å—Ç—å: $172.13/–≥–æ–¥

–≠–∫–æ–Ω–æ–º–∏—è: $165.37/–≥–æ–¥ (49%)
```

## üîç –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–µ—à –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º:** –í –ª–æ–≥–∞—Ö —Ç–æ–ª—å–∫–æ `No cached tokens`

**–ü—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

1. **–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env
   echo $OPENAI_MODEL_1
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: gpt-4o, gpt-4o-mini, o1-preview, o1-mini
   ```

2. **–ü—Ä–æ–º–ø—Ç –º–µ–Ω—å—à–µ 1024 —Ç–æ–∫–µ–Ω–æ–≤**
   ```bash
   # –í–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ (~2000+ —Ç–æ–∫–µ–Ω–æ–≤) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã ‚úÖ
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ rules_text –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ config.yaml
   ```

3. **–ë–æ–ª—å—à–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏**
   ```bash
   # –ö–µ—à –∂–∏–≤–µ—Ç 5-10 –º–∏–Ω—É—Ç
   # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ batch_size: 10+ –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∏–π cache hit rate (<50%)

**–°–∏–º–ø—Ç–æ–º:** `Prompt cache hit: 500/2500 tokens (20%)`

**–ü—Ä–∏—á–∏–Ω—ã:**
- Rules –∏–ª–∏ allowed_statuses –º–µ–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω
git pull
# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
ls -la status_validator/prompt_builder.py
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–¥–∞–≤–Ω—è—è –¥–∞—Ç–∞ (–ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π)
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production

### –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫

–î–æ–±–∞–≤—å—Ç–µ –≤ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥ –ª–æ–≥–æ–≤:

```bash
#!/bin/bash
LOG_FILE="/var/log/status-validator.log"

status-validator --config config.yaml --verbose 2>&1 | tee "$LOG_FILE"

# –ò–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞
CACHE_HITS=$(grep "Prompt cache hit" "$LOG_FILE" | wc -l)
AVG_CACHE_RATE=$(grep "Prompt cache hit" "$LOG_FILE" | \
  awk -F'[(%]' '{sum += $(NF-1); count++} END {print sum/count}')

echo "Cache hits: $CACHE_HITS"
echo "Average cache rate: ${AVG_CACHE_RATE}%"
```

### –ê–ª–µ—Ä—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∫–µ—à–∞:

```bash
# –ï—Å–ª–∏ cache hit rate < 70% –∏–ª–∏ cache hits == 0
if (( $(echo "$AVG_CACHE_RATE < 70" | bc -l) )); then
    echo "WARNING: Low cache hit rate: ${AVG_CACHE_RATE}%"
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
fi
```

## üéì Best Practices

### 1. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π batch_size

```yaml
# –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–µ—à–∞:
batch_size: 10  # –ú–∏–Ω–∏–º—É–º –¥–ª—è –º–∞–ª—ã—Ö –æ–±—ä–µ–º–æ–≤
batch_size: 20  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è 50-200 —Å—Ç—Ä–æ–∫
batch_size: 50  # –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ (200+ —Å—Ç—Ä–æ–∫)
```

### 2. Scheduled runs

```bash
# –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ, –∞ –Ω–µ —Å –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏
# ‚ùå –ü–ª–æ—Ö–æ: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ —Å –ø–∞—É–∑–∞–º–∏
0 9 * * * status-validator --limit 50
0 10 * * * status-validator --limit 50

# ‚úÖ –•–æ—Ä–æ—à–æ: –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
0 9 * * * status-validator
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ fallback –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

```yaml
llm:
  providers:
    1:
      model: gpt-4o              # Primary —Å –∫–µ—à–µ–º
    2:
      model: gpt-4o-mini         # –î–µ—à–µ–≤—ã–π fallback —Å –∫–µ—à–µ–º
    3:
      model: gpt-4-turbo         # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ –∫–µ—à–∞
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å `--verbose`
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–µ—à–∞ –≤ –ª–æ–≥–∞—Ö
4. ‚úÖ –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞ production
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [PROMPT_CACHING.md](PROMPT_CACHING.md) - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [OpenAI Prompt Caching](https://platform.openai.com/docs/guides/prompt-caching) - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [README.md](README.md) - –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –í–∫–ª—é—á–∏—Ç–µ `--verbose` –∏ –∏–∑—É—á–∏—Ç–µ –ª–æ–≥–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏ –≤ `.env`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `openai>=1.12.0`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ rules_text –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ config.yaml

